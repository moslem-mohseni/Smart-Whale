```md
# **📚 مستندات جامع ماژول Storage - نسخه ۱.۰ | تاریخ: ۲۰۲5-03-24**

---

## **📌 مقدمه**
ماژول **Storage** یکی از اجزای حیاتی سیستم است که وظیفه‌ی مدیریت و ذخیره‌سازی داده‌های مربوط به پشتیبان‌گیری، پیکربندی، لاگ‌ها، مدل‌های پایگاه داده، مانیتورینگ، اسکریپت‌های اجرایی و منابع مشترک را بر عهده دارد. این ماژول با هدف **یکپارچگی، مقیاس‌پذیری و استانداردسازی** طراحی شده است و به تیم‌های توسعه کمک می‌کند تا بتوانند با ثبات و سرعت بالاتر به نگهداری و بهبود سیستم بپردازند.

### **🎯 اهداف اصلی ماژول Storage**
✅ **مدیریت نسخه‌های پشتیبان** با قابلیت تفکیک بین بخش‌های توسعه‌دهنده، زبان و اشتراکی  
✅ **ذخیره و مدیریت تنظیمات سیستم** جهت یکپارچگی ابزارهای پایگاه داده و مانیتورینگ  
✅ **ثبت لاگ‌های عملکرد، خطاها و متریک‌های سیستم** برای بهبود کارایی و عیب‌یابی  
✅ **مدیریت مدل‌های پایگاه داده و اسکیماها** با استفاده از کلاس‌های پایه استاندارد  
✅ **پشتیبانی از اسکریپت‌های اجرایی و منابع مشترک** جهت اجرای وظایف عملیاتی به‌صورت خودکار  
✅ **ارتباط یکپارچه بین اجزای مختلف سیستم** از طریق ساختار مدولار و تعریف استاندارد

---

## **🏗️ ساختار کلی ماژول Storage**
ماژول Storage به‌صورت کاملاً مدولار و طبق الگوهای معماری مدرن طراحی شده است. ساختار پوشه‌بندی آن به تیم توسعه امکان می‌دهد تا هر بخش را به‌راحتی شناسایی، مدیریت و توسعه دهند.

```plaintext
storage/
├── backups/                    # نگهداری نسخه‌های پشتیبان
│   ├── developer/              # پشتیبان‌های مربوط به توسعه‌دهنده
│   ├── language/               # پشتیبان‌های مرتبط با تنظیمات زبان
│   └── shared/                 # پشتیبان‌های بخش‌های مشترک
│
├── config/                     # تنظیمات پیکربندی سیستم
│   ├── clickhouse/             # تنظیمات پایگاه داده ClickHouse
│   ├── grafana/                # تنظیمات داشبوردهای Grafana
│   └── prometheus/             # تنظیمات مانیتورینگ با Prometheus
│
├── logs/                       # لاگ‌های سیستم
│   ├── access/                 # لاگ‌های دسترسی کاربران
│   ├── app/                    # لاگ‌های اپلیکیشن
│   ├── errors/                 # ثبت خطاهای سیستم
│   └── metrics/                # متریک‌ها و گزارشات عملکرد
│
├── models/                     # مدل‌های پایگاه داده و اسکیماها
│   ├── developer/              # مدل‌های اختصاصی توسعه‌دهنده
│   ├── language/               # مدل‌های اختصاصی زبان
│   │   └── persian/
│   │       └── db/
│   │           └── schemas/    # اسکیماهای اصلی زبان فارسی (با کلاس‌های پایه)
│   └── shared/                 # منابع و اسکیماهای مشترک
│       └── __init__.py
│
├── monitoring/                 # ابزارهای مانیتورینگ و پایش سیستم
│   ├── grafana/                # داشبوردهای Grafana
│   └── prometheus/             # تنظیمات Prometheus
│
├── scripts/                    # اسکریپت‌های اجرایی و کلاس‌های پایه
│   └── base_schema.py          # تعریف کلاس‌های پایه برای اسکیماها
│
└── shared/                     # منابع و فایل‌های مشترک
    ├── cache/                 # فایل‌های کش شده
    ├── db/                    # فایل‌های مرتبط با پایگاه داده
    ├── kafka/                 # تنظیمات Kafka
    ├── tmp/                   # فایل‌های موقتی
    ├── uploads/               # فایل‌های آپلود شده توسط کاربران
    └── __init__.py            # تعریف فضای نام مشترک
```

---

## **🔍 بررسی اجزای کلیدی ماژول Storage**

### **1. Backups**
- **مکان:** `storage/backups/`
- **وظیفه:** نگهداری نسخه‌های پشتیبان به‌صورت تفکیکی برای بخش‌های مختلف سیستم
- **زیرساختار:**
  - **developer:** پشتیبان‌های مربوط به تغییرات کد و تنظیمات توسعه‌دهنده
  - **language:** پشتیبان‌های مرتبط با تنظیمات زبان و مدل‌های زبانی
  - **shared:** نسخه‌های پشتیبان منابع و داده‌های مشترک

---

### **2. Config**
- **مکان:** `storage/config/`
- **وظیفه:** ذخیره تنظیمات و پیکربندی ابزارهای مورد استفاده در سیستم
- **زیرساختار:**
  - **clickhouse:** پیکربندی پایگاه داده ClickHouse برای ذخیره و پردازش داده‌های تحلیلی
  - **grafana:** تنظیمات داشبوردهای مانیتورینگ با Grafana برای نمایش متریک‌ها و گزارشات
  - **prometheus:** فایل‌های تنظیمات مربوط به مانیتورینگ سیستم با استفاده از Prometheus

---

### **3. Logs**
- **مکان:** `storage/logs/`
- **وظیفه:** ثبت لاگ‌های مربوط به دسترسی، عملکرد، خطاها و متریک‌های سیستم جهت مانیتورینگ و عیب‌یابی
- **زیرساختار:**
  - **access:** ثبت لاگ‌های مربوط به ورود و خروج کاربران
  - **app:** ثبت لاگ‌های عملکرد اپلیکیشن
  - **errors:** ذخیره خطاهای سیستم جهت عیب‌یابی
  - **metrics:** جمع‌آوری و ذخیره متریک‌های سیستم جهت تحلیل عملکرد

---

### **4. Models**
- **مکان:** `storage/models/`
- **وظیفه:** نگهداری مدل‌های پایگاه داده و اسکیماهای مرتبط با بخش‌های مختلف سیستم
- **ساختار تفکیکی:**
  - **developer:** مدل‌های اختصاصی مربوط به توسعه‌دهنده
  - **language:** مدل‌های اختصاصی زبان، به‌ویژه زبان فارسی
    - **persian/db/schemas:** اسکیماهای اصلی زبان فارسی که تمامی آن‌ها باید از کلاس‌های پایه پیروی کنند
  - **shared:** منابع و اسکیماهای مشترک بین بخش‌های مختلف

---

### **5. Monitoring**
- **مکان:** `storage/monitoring/`
- **وظیفه:** تنظیم و پایش عملکرد سیستم با استفاده از ابزارهای مانیتورینگ
- **زیرساختار:**
  - **grafana:** داشبوردهای مانیتورینگ جهت نمایش عملکرد سیستم
  - **prometheus:** فایل‌های تنظیمات جهت جمع‌آوری متریک‌های سیستم

---

### **6. Scripts**
- **مکان:** `storage/scripts/`
- **وظیفه:** اجرای اسکریپت‌های اجرایی و تعریف کلاس‌های پایه برای اسکیماها
- **ویژگی‌های کلیدی:**
  - **base_schema.py:** تعریف کلاس‌های پایه مانند ClickHouseSchema، MilvusSchema و TimescaleDBSchema
  - **کاربرد:** تضمین یکنواختی و استانداردسازی ایجاد اسکیماها در سراسر پروژه

---

### **7. Shared**
- **مکان:** `storage/shared/`
- **وظیفه:** ذخیره منابع و فایل‌های مشترک مورد استفاده در پروژه
- **زیرساختار:**
  - **cache:** نگهداری فایل‌های کش شده برای بهبود سرعت پردازش
  - **db:** فایل‌ها و ماژول‌های مرتبط با پایگاه داده‌های مورد استفاده
  - **kafka:** تنظیمات مربوط به سیستم پیام‌رسان Kafka جهت پردازش داده‌ها
  - **tmp:** ذخیره‌سازی فایل‌های موقتی
  - **uploads:** نگهداری فایل‌های آپلود شده توسط کاربران
  - **__init__.py:** تعریف فضای نام و فراهم کردن دسترسی یکپارچه به منابع مشترک

---

## **📌 اسکیماها و کلاس‌های پایه**

### **مقدمه بر اسکیماها**
در سیستم Storage، اسکیماهای پایگاه داده نقش کلیدی در مدیریت داده‌ها دارند. تمامی اسکیماها باید از کلاس‌های پایه استاندارد پیروی کنند تا یکپارچگی و یکنواختی در تمامی دستورات ایجاد و مدیریت پایگاه داده تضمین شود. به این منظور، سه کلاس پایه اصلی تعریف شده‌اند:

- **ClickHouseSchema:** برای اسکیماهای مربوط به پایگاه داده ClickHouse  
- **MilvusSchema:** برای تعریف مجموعه‌های برداری (Collections) در Milvus  
- **TimescaleDBSchema:** برای اسکیماهای مربوط به پایگاه داده TimescaleDB

### **1. مکان کلاس‌های پایه**
- **مسیر:** `storage/shared/db/schemas/`
- **وظیفه:** تعریف و پیاده‌سازی متدهای استاندارد مانند `get_create_statement` و `get_check_exists_statement` برای ایجاد، بررسی و نگهداری جداول و مجموعه‌ها

### **2. متدهای اصلی کلاس‌های پایه**
| **متد**                          | **وظیفه**                                                                                   |
|-----------------------------------|---------------------------------------------------------------------------------------------|
| `get_create_statement()`          | تولید دستور ایجاد جدول یا مجموعه به‌صورت دینامیک بر اساس ویژگی‌های کلاس                    |
| `get_check_exists_statement()`    | بررسی وجود جدول یا مجموعه در پایگاه داده جهت جلوگیری از ایجاد مجدد                          |
| `name` (ویژگی)                    | تعیین نام یکتای جدول یا مجموعه                                                              |
| `description` (ویژگی)             | توضیح عملکرد و هدف از وجود جدول یا مجموعه                                                   |
| `database_name` یا `schema_name`   | مشخص کردن پایگاه داده یا اسکیما جهت قرارگیری جدول (برای TimescaleDB)                         |

این متدها و ویژگی‌ها تضمین می‌کنند که تمامی اسکیماها به‌طور یکنواخت و استاندارد تعریف شده و نگهداری می‌شوند.

---

## **📌 اسکیماهای اصلی زبان فارسی**

### **مکان و دسته‌بندی**
- **مسیر اصلی:** `storage/models/language/persian/db/schemas/`
- **وظیفه:** تعریف اسکیماهای مربوط به زبان فارسی شامل مدیریت پیام‌ها، فایل‌ها، کاربران، اشتراک‌ها، و گزارشات تحلیلی
- **دسته‌بندی اسکیماها:**
  - **اسکیماهای ClickHouse:** مدیریت رویدادهای سیستمی، آمار استفاده و متریک‌ها  
  - **اسکیماهای Milvus:** ذخیره بردارهای تعبیه شده برای چت و دانش‌پایه  
  - **اسکیماهای TimescaleDB:** مدیریت جداول مرتبط با چت‌ها، پیام‌ها، کاربران، و اشتراک‌ها

### **نمونه‌های اسکیما**
#### **اسکیماهای ClickHouse**
- **EventsTable:** ثبت رویدادهای سیستمی جهت تحلیل عملکرد  
- **FileEventsTable:** مدیریت رویدادهای مرتبط با عملیات فایل (آپلود، دانلود، حذف)  
- **UsageStatsTable:** ثبت آمار و متریک‌های استفاده کاربران و مدل‌ها

#### **اسکیماهای Milvus**
- **ChatEmbeddingsCollection:** نگهداری بردارهای تعبیه شده چت جهت جستجوی معنایی  
- **KnowledgeBaseCollection:** ذخیره بردارهای تعبیه شده دانش‌پایه جهت جستجوی اطلاعات

#### **اسکیماهای TimescaleDB**
- **ChatsTable:** مدیریت اطلاعات مکالمات چت با جزئیات نظیر عنوان، توضیحات، وضعیت آرشیو  
- **MessagesTable:** ثبت پیام‌های چت با اطلاعاتی مانند محتوا، زمان ایجاد، وضعیت و متادیتا  
- **FileHashesTable:** مدیریت هش‌های فایل جهت جلوگیری از تکرار داده‌ها  
- **FileReferencesTable:** ثبت ارتباط بین پیام‌ها و فایل‌ها (ضمیمه‌ها، بندانگشتی‌ها)  
- **ReactionsTable:** ذخیره واکنش‌های کاربران به پیام‌ها  
- **SchemaVersionTable:** پیگیری تغییرات و نسخه‌بندی اسکیماها  
- **UserSubscriptionsTable:** مدیریت اشتراک‌های کاربران از نظر نوع و وضعیت پرداخت  
- **UsersTable:** ثبت اطلاعات کاربران شامل نام، ایمیل، پسورد و تنظیمات پروفایل

---

## **📌 یکپارچگی و استانداردسازی اسکیماها**

### **اصول کلیدی**
- **استفاده اجباری از کلاس‌های پایه:**  
  تمامی اسکیماها باید از کلاس‌های پایه مربوط به پایگاه داده (ClickHouseSchema، MilvusSchema، TimescaleDBSchema) ارث‌بری کنند تا یکنواختی در ایجاد، به‌روزرسانی و نگهداری داده‌ها حفظ شود.
  
- **نام‌گذاری یکپارچه:**  
  ویژگی‌های `name`، `description` و `database_name` یا `schema_name` در تمامی اسکیماها به‌صورت استاندارد تعریف شده‌اند.
  
- **مدیریت تغییرات:**  
  استفاده از فایل‌هایی مانند **schema_version.py** جهت ثبت تغییرات و نسخه‌بندی اسکیماها به توسعه‌دهندگان کمک می‌کند تا بتوانند تغییرات را پیگیری و مستندسازی کنند.

### **راهنمای توسعه‌دهندگان**
✅ **قبل از افزودن اسکیماهای جدید،** اطمینان حاصل کنید که الگوهای تعریف شده در کلاس‌های پایه رعایت شده است.  
✅ **پس از ایجاد اسکیما،** از متد `get_check_exists_statement` برای بررسی وجود مجدد آن استفاده کنید.  
✅ **در صورت اعمال تغییرات در ساختار اسکیما،** فایل‌های نسخه‌بندی مانند **schema_version.py** را به‌روزرسانی نمایید.  
✅ **مستندسازی دقیق تغییرات،** به تیم‌های دیگر کمک می‌کند تا از روند توسعه مطلع شوند.

---

## **📌 جدول خلاصه فایل‌ها و اسکیماها در ماژول Storage**

| **نام فایل / ماژول**                  | **نوع پایگاه داده** | **توضیحات**                                                                                              | **مسیر**                                                    |
|---------------------------------------|---------------------|----------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|
| __init__.py (مشترک)                   | -                   | معرفی کلاس‌های پایه و اسکیماهای مشترک (ClickHouse, Milvus, TimescaleDB)                                  | storage/shared/db/schemas/                                  |
| events.py                             | ClickHouse          | ثبت رویدادهای سیستمی جهت تحلیل عملکرد                                                                   | storage/shared/db/schemas/                                  |
| file_events.py                        | ClickHouse          | ثبت رویدادهای مرتبط با عملیات فایل (آپلود، دانلود، حذف)                                                  | storage/shared/db/schemas/                                  |
| usage_stats.py                        | ClickHouse          | ثبت آمار و متریک‌های استفاده کاربران                                                                    | storage/shared/db/schemas/                                  |
| chat_embeddings.py                    | Milvus              | نگهداری بردارهای تعبیه شده چت                                                                             | storage/shared/db/schemas/                                  |
| knowledge_base.py                     | Milvus              | ذخیره بردارهای تعبیه شده دانش‌پایه                                                                       | storage/shared/db/schemas/                                  |
| chats.py                              | TimescaleDB         | مدیریت اطلاعات مکالمات چت با جزئیات دقیق                                                                | storage/shared/db/schemas/                                  |
| file_hashes.py                        | TimescaleDB         | مدیریت هش‌های فایل جهت جلوگیری از تکرار داده‌ها                                                         | storage/shared/db/schemas/                                  |
| file_references.py                    | TimescaleDB         | ثبت ارتباط بین پیام‌ها و فایل‌ها (ضمیمه، بندانگشتی)                                                     | storage/models/language/persian/db/schemas/                 |
| files.py                              | TimescaleDB         | ذخیره اطلاعات متادیتای فایل‌های آپلود‌شده                                                               | storage/models/language/persian/db/schemas/                 |
| messages.py                           | TimescaleDB         | ثبت پیام‌های چت به همراه جزئیات مانند محتوا، وضعیت و متادیتا                                           | storage/models/language/persian/db/schemas/                 |
| reactions.py                          | TimescaleDB         | ثبت واکنش‌های کاربران به پیام‌ها                                                                        | storage/models/language/persian/db/schemas/                 |
| schema_version.py                     | TimescaleDB         | پیگیری تغییرات و نسخه‌بندی اسکیماها                                                                    | storage/models/language/persian/db/schemas/                 |
| user_subscriptions.py                 | TimescaleDB         | مدیریت اشتراک‌های کاربران و اطلاعات مربوط به پرداخت                                                   | storage/models/language/persian/db/schemas/                 |
| users.py                              | TimescaleDB         | ثبت اطلاعات کاربران شامل نام کاربری، ایمیل، پسورد و تنظیمات پروفایل                                      | storage/models/language/persian/db/schemas/                 |
| analysis_metrics_table.py             | ClickHouse          | ثبت متریک‌های عملکرد تحلیلگر زبان فارسی                                                                | storage/models/language/persian/db/schemas/clickhouse/       |
| dialect_embeddings_collection.py      | Milvus              | ذخیره بردارهای تعبیه شده گویش‌های فارسی                                                                 | storage/models/language/persian/db/schemas/milvus/           |
| analysis_reports_table.py             | TimescaleDB         | ذخیره گزارش‌های تحلیل و نتایج پردازش متون                                                               | storage/models/language/persian/db/schemas/timescaledb/      |
| __init__.py (ClickHouse)              | -                   | معرفی اسکیماهای ClickHouse برای زبان فارسی                                                              | storage/models/language/persian/db/schemas/clickhouse/       |
| __init__.py (Milvus)                  | -                   | معرفی مجموعه‌های برداری (Milvus) برای زبان فارسی                                                         | storage/models/language/persian/db/schemas/milvus/           |
| __init__.py (TimescaleDB)             | -                   | معرفی اسکیماهای TimescaleDB برای زبان فارسی                                                              | storage/models/language/persian/db/schemas/timescaledb/      |

---

## **📌 راهنمای استقرار و نگهداری اسکیماها**

### **مراحل استقرار اسکیماها**
1. **بارگذاری کلاس‌های پایه:**  
   - ابتدا کلاس‌های پایه موجود در `storage/shared/db/schemas/` باید به درستی لود شوند.
2. **ایجاد پایگاه‌های داده و جداول:**  
   - استفاده از متد `get_create_statement` جهت تولید دستورات DDL و ایجاد پایگاه‌های داده مورد نیاز.
3. **بررسی وجود جداول:**  
   - اجرای `get_check_exists_statement` برای جلوگیری از ایجاد دوباره جدول‌های موجود.
4. **نظارت بر عملکرد:**  
   - پس از استقرار، ابزارهای مانیتورینگ مانند Prometheus و Grafana برای نظارت بر عملکرد جداول به کار گرفته می‌شوند.

### **توصیه‌های نگهداری**
- **مدیریت نسخه‌بندی:**  
  - هر تغییر در ساختار اسکیماها باید در فایل **schema_version.py** ثبت شود.
- **اجرای تست‌های یکپارچه:**  
  - قبل از اعمال تغییرات در محیط‌های تولید، تست‌های یکپارچه و CI/CD باید اجرا شوند.
- **بهینه‌سازی ایندکس‌ها:**  
  - ایندکس‌های ایجاد شده باید به‌صورت دوره‌ای مورد ارزیابی قرار گیرند تا کارایی جستجوها بهبود یابد.
- **مستندسازی تغییرات:**  
  - هر تغییر در اسکیماها باید مستندسازی شده و به تیم‌های مرتبط اعلام گردد.

---

## **📌 نکات فنی و توصیه‌های توسعه**

### **نکات کلیدی برای توسعه‌دهندگان**
- **پیروی از استانداردهای کلاس‌های پایه:**  
  - در زمان ایجاد اسکیماهای جدید، از کلاس‌های پایه **ClickHouseSchema**، **MilvusSchema** و **TimescaleDBSchema** استفاده کنید.
- **یکپارچگی نامگذاری:**  
  - از ویژگی‌های استاندارد مانند `name`، `description` و `database_name` یا `schema_name` به‌طور یکنواخت استفاده نمایید.
- **تست و اعتبارسنجی:**  
  - از متد `get_check_exists_statement` برای اعتبارسنجی وجود جداول پیش از اجرای دستورات DDL بهره بگیرید.
- **مدیریت خطاها:**  
  - خطاهای مربوط به ایجاد جداول یا مجموعه‌ها باید به سرعت شناسایی و رفع شوند.
- **بهینه‌سازی عملکرد:**  
  - پس از استقرار اسکیماها، ایندکس‌ها و بهینه‌سازی‌های لازم جهت افزایش کارایی سیستم اعمال شوند.

### **توصیه‌های پیشرفته**
- **ادغام با CI/CD:**  
  - استفاده از ابزارهای CI/CD جهت اجرای تست‌های یکپارچه و بررسی دستورات DDL قبل از اعمال تغییرات در محیط تولید.
- **مانیتورینگ دقیق:**  
  - استفاده از داشبوردهای Grafana و تنظیمات Prometheus جهت نظارت بر عملکرد سیستم در زمان واقعی.
- **بهبود مستمر:**  
  - مستندسازی دقیق تغییرات و دریافت بازخورد از تیم‌های توسعه جهت بهبود ساختار اسکیماها و استانداردهای پیاده‌سازی.
- **هماهنگی بین تیم‌ها:**  
  - ارتباط مستمر میان تیم‌های توسعه، پایگاه داده و عملیات جهت بهبود روند توسعه و رفع مشکلات احتمالی.

---

## **📌 دیاگرام ساختاری ماژول Storage**

```plaintext
┌─────────────────────────────┐
│          storage            │
├─────────────┬───────────────┤
│  backups    │   config      │
├─────────────┼───────────────┤
│    logs     │   models      │
├─────────────┼───────────────┤
│ monitoring  │   scripts     │
├─────────────┼───────────────┤
│   shared    │               │
└─────────────┴───────────────┘
```

**توضیح دیاگرام:**
- **Backups:** نگهداری نسخه‌های پشتیبان
- **Config:** تنظیمات پیکربندی سیستم
- **Logs:** ثبت لاگ‌های دسترسی، عملکرد، خطاها و متریک‌ها
- **Models:** شامل اسکیماهای پایگاه داده برای زبان فارسی و سایر مدل‌ها
- **Monitoring:** تنظیمات پایش و مانیتورینگ سیستم
- **Scripts:** اسکریپت‌های اجرایی و کلاس‌های پایه جهت استانداردسازی اسکیماها
- **Shared:** منابع و فایل‌های مشترک مورد استفاده در پروژه

---

## **📌 ارتباط ماژول Storage با سایر بخش‌های سیستم**

| **بخش مرتبط**   | **نحوه تعامل با Storage**                                                                                 |
|-----------------|------------------------------------------------------------------------------------------------------------|
| **API Layer**   | استفاده از داده‌های ذخیره‌شده برای ارائه پاسخ به درخواست‌های کاربر و مدیریت نشست‌های کاربران             |
| **Monitoring**  | دریافت متریک‌ها و گزارش‌های عملکرد از لاگ‌ها و اسکیماهای ذخیره‌شده جهت تحلیل عملکرد سیستم                  |
| **DevOps**      | استفاده از فایل‌های پیکربندی موجود در `config/` جهت استقرار، به‌روزرسانی و مدیریت سیستم پایگاه‌های داده      |
| **Data Analytics** | استفاده از اسکیماهای تحلیلی (ClickHouse، TimescaleDB) جهت تجزیه و تحلیل داده‌های جمع‌آوری شده و گزارش‌گیری      |

---

## **📌 نمونه کدهای کاربردی**

### **مثال ۱: ایجاد یک جدول جدید در ClickHouse با استفاده از کلاس پایه**
```python
from storage.scripts.base_schema import ClickHouseSchema

class CustomEventsTable(ClickHouseSchema):
    @property
    def name(self) -> str:
        return "custom_events"

    @property
    def description(self) -> str:
        return "جدول نمونه برای رویدادهای سفارشی"

    @property
    def database_name(self) -> str:
        return "custom_db"

    def get_create_statement(self) -> str:
        return f"""
        CREATE DATABASE IF NOT EXISTS {self.database_name};
        CREATE TABLE IF NOT EXISTS {self.database_name}.{self.name} (
            event_date Date,
            event_time DateTime,
            event_type LowCardinality(String),
            details String
        ) ENGINE = MergeTree()
        PARTITION BY toYYYYMM(event_date)
        ORDER BY (event_type, event_time);
        COMMENT ON TABLE {self.database_name}.{self.name} IS 'جدول رویدادهای سفارشی';
        """
```

---

### **مثال ۲: تعریف یک مجموعه برداری در Milvus با استفاده از کلاس پایه**
```python
from storage.scripts.base_schema import MilvusSchema
from pymilvus import DataType

class CustomEmbeddingsCollection(MilvusSchema):
    @property
    def name(self) -> str:
        return "custom_embeddings"

    @property
    def description(self) -> str:
        return "مجموعه نمونه بردارهای تعبیه شده سفارشی"

    def get_create_statement(self) -> dict:
        return {
            "fields": [
                {"name": "id", "type": DataType.INT64, "is_primary": True},
                {"name": "embedding", "type": DataType.FLOAT_VECTOR, "dim": 1536},
                {"name": "metadata", "type": DataType.JSON}
            ],
            "index_params": {
                "field_name": "embedding",
                "index_type": "HNSW",
                "metric_type": "COSINE",
                "params": {"M": 16, "efConstruction": 200}
            },
            "search_params": {
                "metric_type": "COSINE",
                "params": {"ef": 128}
            },
            "consistency_level": "Strong"
        }
```

---

### **مثال ۳: ایجاد جدول در TimescaleDB با استفاده از کلاس پایه**
```python
from storage.scripts.base_schema import TimescaleDBSchema

class CustomMessagesTable(TimescaleDBSchema):
    @property
    def name(self) -> str:
        return "custom_messages"

    @property
    def description(self) -> str:
        return "جدول نمونه برای ذخیره پیام‌های سفارشی"

    @property
    def schema_name(self) -> str:
        return "public"

    def get_create_statement(self) -> str:
        return f"""
        CREATE SCHEMA IF NOT EXISTS {self.schema_name};
        CREATE TABLE IF NOT EXISTS {self.schema_name}.{self.name} (
            id SERIAL PRIMARY KEY,
            message_id VARCHAR(100) NOT NULL UNIQUE,
            user_id INTEGER,
            content TEXT NOT NULL,
            created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
        );
        SELECT create_hypertable('{self.schema_name}.{self.name}', 'created_at', if_not_exists => TRUE);
        COMMENT ON TABLE {self.schema_name}.{self.name} IS 'جدول پیام‌های سفارشی';
        """
```

---

## **📌 راهنمای استقرار و به‌روزرسانی**

### **مراحل استقرار اسکیماها در محیط تولید**
1. **بارگذاری کلاس‌های پایه:**  
   - اطمینان از لود صحیح کلاس‌های پایه قبل از اجرای هرگونه دستور ایجاد جدول.
2. **اجرای دستورات DDL:**  
   - استفاده از متدهای `get_create_statement` برای ایجاد پایگاه‌های داده و جداول.
3. **بررسی صحت ایجاد جداول:**  
   - اجرای متد `get_check_exists_statement` جهت اطمینان از ایجاد صحیح جداول.
4. **مانیتورینگ و بهبود:**  
   - نظارت بر متریک‌ها و گزارش‌های سیستم جهت بهبود عملکرد پس از استقرار.

### **توصیه‌های نگهداری**
- **ثبت تغییرات:**  
  - تمامی تغییرات در اسکیماها باید در فایل‌های نسخه‌بندی ثبت شوند.
- **اجرای تست‌های یکپارچه:**  
  - قبل از به‌روزرسانی محیط تولید، تست‌های یکپارچه در محیط‌های staging اجرا شود.
- **بهینه‌سازی ایندکس‌ها:**  
  - ایندکس‌های جداول به‌صورت دوره‌ای بررسی و به‌روزرسانی شوند تا کارایی افزایش یابد.

---

## **📌 نکات پایانی**

✅ **ماژول Storage** با طراحی مدولار و استانداردسازی دقیق اسکیماها، بستر یکپارچه‌ای را برای مدیریت داده‌ها فراهم می‌کند.  
✅ **استفاده از کلاس‌های پایه** به تضمین یکنواختی در ایجاد جداول و مجموعه‌ها کمک می‌کند.  
✅ **مستندسازی دقیق** تغییرات و به‌روزرسانی‌های انجام‌شده، زمینه بهبود مستمر سیستم را فراهم می‌آورد.  
✅ **ارتباط یکپارچه** با سایر بخش‌های سیستم (مانند API، Monitoring، Data Analytics) تضمین می‌کند که داده‌ها به صورت صحیح مدیریت و استفاده شوند.

---

## **📌 پیوست‌ها و منابع**

- **پیوست ۱:** فایل‌های __init__.py در پوشه‌های Shared و Models  
- **پیوست ۲:** نمونه کدهای ایجاد اسکیما در ClickHouse، Milvus و TimescaleDB  
- **پیوست ۳:** دیاگرام‌های ساختاری و نمودارهای وابستگی بین اجزای ماژول Storage  
- **منابع:**  
  - مستندات رسمی [ClickHouse](https://clickhouse.com)  
  - راهنمای استفاده از [Milvus](https://milvus.io)  
  - مستندات [TimescaleDB](https://www.timescale.com)  
  - راهنمای داخلی توسعه سیستم

---

## **📌 نکات کلیدی برای توسعه‌دهندگان Storage**

1. **پیروی از الگوهای استاندارد:**  
   - تمامی اسکیماها باید از کلاس‌های پایه تعریف شده ارث‌بری کنند.
2. **یکپارچگی داده‌ها:**  
   - استفاده از نام‌گذاری یکپارچه و تعریف دقیق ویژگی‌ها موجب انسجام در داده‌ها می‌شود.
3. **مدیریت نسخه‌ها:**  
   - فایل‌های نسخه‌بندی (مانند schema_version.py) جهت ثبت تغییرات و به‌روزرسانی ساختار اسکیماها الزامی است.
4. **تست و بهینه‌سازی:**  
   - اجرای تست‌های یکپارچه و بهینه‌سازی ایندکس‌ها جهت بهبود عملکرد سیستم ضروری است.
5. **مستندسازی تغییرات:**  
   - هرگونه تغییر در ساختار اسکیماها باید به صورت دقیق مستندسازی شود و با تیم‌های فنی به اشتراک گذاشته شود.

---

## **📌 جمع‌بندی نهایی**
ماژول **Storage** با پوشش کامل بخش‌های پشتیبان‌گیری، پیکربندی، ثبت لاگ، مدیریت مدل‌های پایگاه داده و منابع مشترک، به عنوان یکی از اجزای حیاتی سیستم، بستر لازم برای پردازش و نگهداری داده‌های کلیدی را فراهم می‌کند. پیروی از استانداردهای تعریف شده در کلاس‌های پایه، تضمین می‌کند که تمامی اسکیماها و جداول ایجاد شده به صورت یکپارچه و بهینه مدیریت شوند. این مستند راهنمای جامعی است که توسعه‌دهندگان و تیم‌های نگهداری می‌توانند به آن مراجعه کرده و در هر مرحله از توسعه و بهبود سیستم از آن بهره‌مند شوند.

---

_تهیه شده توسط تیم توسعه Storage در تاریخ ۲۰۲5-03-24_

---

## **📌 پیشنهادات برای بهبود مستندات آتی**
- **افزودن دیاگرام‌های تعاملی:**  
  استفاده از ابزارهایی مانند Mermaid جهت نمایش دیاگرام‌های تعاملی ساختار پروژه.
- **یکپارچه‌سازی با سیستم‌های مستندسازی:**  
  یکپارچه کردن مستندات با Confluence یا Notion برای دسترسی آسان‌تر تیم‌های فنی.
- **دریافت بازخورد:**  
  نظرات تیم‌های توسعه جهت بهبود مستندات و به‌روز نگه داشتن آن در هر نسخه جدید.
- **توسعه مستمر:**  
  مستندسازی تغییرات هر نسخه از سیستم به صورت دوره‌ای جهت حفظ انسجام و آگاهی همه‌ی اعضای تیم.

---
