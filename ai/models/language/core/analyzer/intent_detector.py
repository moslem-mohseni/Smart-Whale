from typing import Dict, Any, Optional
from langdetect import detect
import importlib

class IntentDetector:
    """
    Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ù…Ø³Ø¦ÙˆÙ„ ØªØ´Ø®ÛŒØµ Ù†ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø³Øª.
    Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙˆØ³Ø· Ù…Ø¹Ù„Ù… Ø§Ø®ØªØµØ§ØµÛŒ Ù‡Ø± Ø²Ø¨Ø§Ù† Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯ Ù…Ø¹Ù„Ù… Ø§Ø®ØªØµØ§ØµÛŒØŒ
    Ø§Ø² `mBERT` Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    """

    def __init__(self, language: Optional[str] = None):
        """
        Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªØ´Ø®ÛŒØµ Ù†ÛŒØª Ú©Ø§Ø±Ø¨Ø±.
        :param language: Ø²Ø¨Ø§Ù† ÙˆØ±ÙˆØ¯ÛŒ (Ø¯Ø± ØµÙˆØ±Øª `None`ØŒ Ø²Ø¨Ø§Ù† Ø¨Ù‡â€ŒØ·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        """
        self.language = language
        self.teacher_model = self._load_teacher()

    def _detect_language(self, text: str) -> str:
        """
        ØªØ´Ø®ÛŒØµ Ø²Ø¨Ø§Ù† Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ØªØ¹ÛŒÛŒÙ† Ø²Ø¨Ø§Ù† Ø¯Ø± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡.
        :param text: Ø¬Ù…Ù„Ù‡ ÙˆØ±ÙˆØ¯ÛŒ
        :return: Ø²Ø¨Ø§Ù† Ø´Ù†Ø§Ø³Ø§ÛŒÛŒâ€ŒØ´Ø¯Ù‡
        """
        if not self.language:
            try:
                detected_lang = detect(text)
                return detected_lang
            except:
                return "unknown"
        return self.language

    def _load_teacher(self):
        """
        Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¹Ù„Ù… Ø§Ø®ØªØµØ§ØµÛŒ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯.
        :return: Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø¹Ù„Ù… Ø§Ø®ØªØµØ§ØµÛŒ ÛŒØ§ Ù…Ø¹Ù„Ù… Ø¹Ù…ÙˆÙ…ÛŒ (`mBERT`) Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯
        """
        try:
            module_path = f"ai.models.language.adaptors.{self.language}.language_processor"
            return importlib.import_module(module_path).LanguageProcessor()
        except ModuleNotFoundError:
            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `mBERT` Ø¨Ø±Ø§ÛŒ Ø²Ø¨Ø§Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ø¹Ù„Ù… Ø§Ø®ØªØµØ§ØµÛŒ Ù†Ø¯Ø§Ø±Ù†Ø¯
            return importlib.import_module("ai.models.language.adaptors.multilingual.intent_teacher").IntentTeacher()

    def detect_intent(self, text: str) -> Dict[str, Any]:
        """
        ØªØ´Ø®ÛŒØµ Ù†ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ø¹Ù„Ù… Ø§Ø®ØªØµØ§ØµÛŒ Ù‡Ø± Ø²Ø¨Ø§Ù†.
        :param text: Ø¬Ù…Ù„Ù‡ ÙˆØ±ÙˆØ¯ÛŒ
        :return: Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø´Ø§Ù…Ù„ Ù†ÛŒØª ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡
        """
        return self.teacher_model.detect_intent(text)

    def analyze_intent(self, text: str) -> Dict[str, Any]:
        """
        ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ Ù†ÛŒØª Ø¬Ù…Ù„Ù‡ Ø´Ø§Ù…Ù„ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ.
        Ø§Ú¯Ø± Ø²Ø¨Ø§Ù†ØŒ Ù…Ø¹Ù„Ù… Ø§Ø®ØªØµØ§ØµÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² `adaptors/` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        :param text: Ø¬Ù…Ù„Ù‡ ÙˆØ±ÙˆØ¯ÛŒ
        :return: Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø´Ø§Ù…Ù„ Ù†ÛŒØª ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡
        """
        self.language = self._detect_language(text)
        self.teacher_model = self._load_teacher()

        return {
            "language": self.language,
            "intent_analysis": self.detect_intent(text),
        }


# ØªØ³Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø§Ú˜ÙˆÙ„
if __name__ == "__main__":
    detector = IntentDetector()

    text_sample_en = "Can you help me find the best AI model?"
    text_sample_fa = "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¨Ù‡ Ù…Ù† Ú©Ù…Ú© Ú©Ù†ÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø¯Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù…ØŸ"
    text_sample_ru = "ĞœĞ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ğ¼Ğ½Ğµ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ»ÑƒÑ‡ÑˆÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¸ÑĞºÑƒÑÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ½Ñ‚ĞµĞ»Ğ»ĞµĞºÑ‚Ğ°?"

    analysis_result_en = detector.analyze_intent(text_sample_en)
    analysis_result_fa = detector.analyze_intent(text_sample_fa)
    analysis_result_ru = detector.analyze_intent(text_sample_ru)

    print("ğŸ”¹ English Intent Analysis:")
    print(analysis_result_en)

    print("\nğŸ”¹ Persian Intent Analysis:")
    print(analysis_result_fa)

    print("\nğŸ”¹ Russian Intent Analysis:")
    print(analysis_result_ru)
