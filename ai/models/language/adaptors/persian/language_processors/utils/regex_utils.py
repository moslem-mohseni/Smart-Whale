# persian/language_processors/utils/regex_utils.py
"""
ูุงฺูู regex_utils.py

ุงู ูุงฺูู ูุฌููุนูโุง ุฌุงูุน ุงุฒ ุงูฺฏููุง (regex) ุจุฑุง ุงุณุชุฎุฑุงุฌ ููุฌูุฏุชโูุง ูุฎุชูู ุงุฒ ูุชูโูุง ูุงุฑุณ ุฑุง ูุฑุงูู ูโฺฉูุฏ.
ุงู ุงูฺฏููุง ุดุงูู ููุงุฑุฏ ุฒุฑ ูโุดููุฏ:
  - ุงูู
  - URL (ุดุงูู http ู https)
  - ุดูุงุฑู ุชูููโูุง ุงุฑุงู (ููุจุงู ู ุซุงุจุช)
  - ุชุงุฑุฎ ุดูุณ
  - ุชุงุฑุฎ ููุงุฏ
  - ุฒูุงู (ุจุง ูพุดุชุจุงู ุงุฒ ูุฑูุชโูุง ูุฎุชูู)
  - ูุจุงูุบ ูพูู (ุจุง ูุงุญุฏูุง ุฑุงุฌ)
  - ุฏุฑุตุฏ
  - ฺฉุฏ ูู ุงุฑุงู (10 ุฑูู)
  - ฺฉุฏ ูพุณุช ุงุฑุงู (10 ุฑูู)
  - ุขุฏุฑุณ IPv4
  - ุขุฏุฑุณ IPv6
  - ูุดุชฺฏโูุง ุฑุณุงููโูุง ุงุฌุชูุงุน (ุจุง ูพุดุชุจุงู ุงุฒ ุญุฑูู ูุงุฑุณ)
  - ููุดูโูุง ุดุจฺฉูโูุง ุงุฌุชูุงุน (ุจุง ูพุดุชุจุงู ุงุฒ ุญุฑูู ูุงุฑุณ)
  - ุงููุฌ (ุฏุฑ ูุญุฏูุฏูโูุง ุฑุงุฌ)
  - ุงุนุฏุงุฏ (ุจู ุตูุฑุช ูุงุฑุณ ู ุงูฺฏูุณ)
  - ุชฺฏโูุง HTML
  - ุดูุงุฑู ฺฉุงุฑุช ุงุนุชุจุงุฑ (13 ุชุง 16 ุฑูู)
"""

import re
from typing import List, Dict

PATTERNS = {
    "EMAIL": {
        "pattern": r"\b[\w\.-]+@[\w\.-]+\.\w+\b",
        "description": "ุชุดุฎุต ุขุฏุฑุณ ุงูู"
    },
    "URL": {
        "pattern": r"(https?://[^\s]+)",
        "description": "ุชุดุฎุต URL ุดุงูู http ุง https"
    },
    "PHONE_IR": {
        "pattern": r"\b(?:\+98|0098|0)(?:9\d{9}|\d{2,3}-?\d{7,8})\b",
        "description": "ุชุดุฎุต ุดูุงุฑู ุชููู ุงุฑุงู (ููุจุงู ุง ุชููู ุซุงุจุช)"
    },
    "DATE_PERSIAN": {
        "pattern": r"\b\d{1,2}[/\-]\d{1,2}[/\-]\d{2,4}\b|\b\d{1,2}\s+("
                   r"?:ูุฑูุฑุฏู|ุงุฑุฏุจูุดุช|ุฎุฑุฏุงุฏ|ุชุฑ|ูุฑุฏุงุฏ|ุดูุฑูุฑ|ููุฑ|ุขุจุงู|ุขุฐุฑ|ุฏ|ุจููู|ุงุณููุฏ)\s+\d{2,4}\b",
        "description": "ุชุดุฎุต ุชุงุฑุฎ ุดูุณ ุฏุฑ ฺูุฏ ูุฑูุช"
    },
    "DATE_GREGORIAN": {
        "pattern": r"\b\d{4}[/\-]\d{1,2}[/\-]\d{1,2}\b",
        "description": "ุชุดุฎุต ุชุงุฑุฎ ููุงุฏ ุจู ุตูุฑุช YYYY/MM/DD ุง YYYY-MM-DD"
    },
    "TIME": {
        "pattern": r"\b\d{1,2}:\d{1,2}(?::\d{1,2})?\s*(?:ู\.ุธ|ุจ\.ุธ|AM|PM)?\b",
        "description": "ุชุดุฎุต ุงูฺฏู ุฒูุงู ุฏุฑ ูุชู"
    },
    "MONEY": {
        "pattern": r"\b\d{1,3}(?:,\d{3})*(?:\.\d+)?\s?(?:ุชููุงู|ุฑุงู|ุฏูุงุฑ|ูุฑู|ูพููุฏ|โฌ|\$|ยฃ|ยฅ)\b|\b("
                   r"?:ุชููุงู|ุฑุงู|ุฏูุงุฑ|ูุฑู|ูพููุฏ|โฌ|\$|ยฃ|ยฅ)\s?\d+(?:,\d{3})*(?:\.\d+)?\b",
        "description": "ุชุดุฎุต ูุจุงูุบ ูพูู ุจุง ูุงุญุฏูุง ุฑุงุฌ"
    },
    "PERCENT": {
        "pattern": r"\b\d+(?:\.\d+)?\s?(?:ูช|%|ุฏุฑุตุฏ)\b",
        "description": "ุชุดุฎุต ุฏุฑุตุฏ ุฏุฑ ูุชู"
    },
    "NATIONAL_ID": {
        "pattern": r"\b\d{10}\b",
        "description": "ุชุดุฎุต ฺฉุฏ ูู ุงุฑุงู (10 ุฑูู)ุ ุจุฑุฑุณ ุตุญุช ุนุฏุฏ ุจู ุณุทุญ ุงูฺฏูุฑุชู ุงูุฌุงู ููโุดูุฏ"
    },
    "POSTAL_CODE": {
        "pattern": r"\b\d{10}\b",
        "description": "ุชุดุฎุต ฺฉุฏ ูพุณุช ุงุฑุงู (10 ุฑูู)"
    },
    "IPV4": {
        "pattern": r"\b(?:(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\b",
        "description": "ุชุดุฎุต ุขุฏุฑุณ IPv4 ูุนุชุจุฑ"
    },
    "IPV6": {
        "pattern": r"\b(?:[A-Fa-f0-9]{1,4}:){7}[A-Fa-f0-9]{1,4}\b",
        "description": "ุชุดุฎุต ุขุฏุฑุณ IPv6 ุณุงุฏู"
    },
    "HASHTAG": {
        "pattern": r"#([\u0600-\u06FF\w]+)",
        "description": "ุชุดุฎุต ูุดุชฺฏโูุง ุฑุณุงููโูุง ุงุฌุชูุงุน (ุจุง ูพุดุชุจุงู ุงุฒ ุญุฑูู ูุงุฑุณ)"
    },
    "MENTION": {
        "pattern": r"@([\u0600-\u06FF\w]+)",
        "description": "ุชุดุฎุต ููุดูโูุง ุดุจฺฉูโูุง ุงุฌุชูุงุน (ุจุง ูพุดุชุจุงู ุงุฒ ุญุฑูู ูุงุฑุณ)"
    },
    "EMOJI": {
        # ุงู ุงูฺฏู ุจุฑุฎ ูุญุฏูุฏูโูุง ุฑุงุฌ ุงููุฌ ุฑุง ูพูุดุด ูโุฏูุฏุ ููฺฉู ุงุณุช ูุงุฒ ุจู ฺฏุณุชุฑุด ุฏุงุดุชู ุจุงุดุฏ.
        "pattern": r"[\U0001F300-\U0001F5FF\U0001F600-\U0001F64F\U0001F680-\U0001F6FF]",
        "description": "ุชุดุฎุต ุงููุฌโูุง ุฑุงุฌ ุฏุฑ ูุชู (ููฺฉู ุงุณุช ุชูุงู ุงููุฌโูุง ุฑุง ูพูุดุด ูุฏูุฏ)"
    },
    "NUMERIC": {
        "pattern": r"\b[0-9ฐ-น]+(?:[.,][0-9ฐ-น]+)?\b",
        "description": "ุชุดุฎุต ุงุนุฏุงุฏ ุจู ุตูุฑุช ุงูฺฏูุณ ุง ูุงุฑุณุ ุดุงูู ุงุนุฏุงุฏ ฺฉุณุฑ"
    },
    "HTML_TAG": {
        "pattern": r"<[^>]+>",
        "description": "ุชุดุฎุต ุชฺฏโูุง HTML ุฏุฑ ูุชู"
    },
    "CREDIT_CARD": {
        "pattern": r"\b(?:\d[ -]*?){13,16}\b",
        "description": "ุชุดุฎุต ุดูุงุฑู ฺฉุงุฑุช ุงุนุชุจุงุฑ (13 ุชุง 16 ุฑูู)"
    }
}


def extract_pattern(text: str, pattern_key: str) -> List[Dict[str, any]]:
    """
    ุงุณุชุฎุฑุงุฌ ุชูุงู ููุงุฑุฏ ููุทุจู ุจุง ฺฉ ุงูฺฏู ูุดุฎุต ุฏุฑ ูุชู.

    Args:
        text (str): ูุชู ูุฑูุฏ
        pattern_key (str): ฺฉูุฏ ุงูฺฏู ุฏุฑ ุฏฺฉุดูุฑ PATTERNS

    Returns:
        List[Dict[str, any]]: ููุฑุณุช ุงุฒ ุฏฺฉุดูุฑโูุง ุดุงูู {'match': str, 'start': int, 'end': int, 'pattern': str}
    """
    if pattern_key not in PATTERNS:
        return []

    pattern_info = PATTERNS[pattern_key]
    pattern = pattern_info["pattern"]

    matches = []
    try:
        for match_obj in re.finditer(pattern, text):
            matches.append({
                "match": match_obj.group(0),
                "start": match_obj.start(),
                "end": match_obj.end(),
                "pattern": pattern_key
            })
    except re.error as e:
        # ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุฎุทุง ุฏุฑ ุงูฺฏู regexุ ุฎุทุง ุฑุง ุซุจุช ูโฺฉูุฏ.
        print(f"ุฎุทุง ุฏุฑ ุงุฌุฑุง regex ุจุฑุง {pattern_key}: {e}")
    return matches


def extract_all_patterns(text: str, pattern_keys: List[str] = None) -> Dict[str, List[Dict[str, any]]]:
    """
    ุงุณุชุฎุฑุงุฌ ุชูุงู ููุงุฑุฏ ููุทุจู ุจุง ูุณุช ุงุฒ ุงูฺฏููุง ุฏุฑ ูุชู.
    ุฏุฑ ุตูุฑุช ุนุฏู ุงุฑุณุงู pattern_keysุ ุชูุงู ุงูฺฏููุง ููุฌูุฏ ุฏุฑ PATTERNS ุจุฑุฑุณ ูโุดููุฏ.

    Args:
        text (str): ูุชู ูุฑูุฏ
        pattern_keys (List[str], optional): ูุณุช ุงุฒ ฺฉูุฏูุง ุงูฺฏููุง ููุฑุฏูุธุฑ ุฏุฑ PATTERNS

    Returns:
        Dict[str, List[Dict[str, any]]]: ุฏฺฉุดูุฑโุง ฺฉู ฺฉูุฏ ุขู ูุงู ุงูฺฏู ู ููุฏุงุฑ ุขู ูุณุช ูุชุงุฌ ุงุณุชุฎุฑุงุฌ ุดุฏู ุงุฒ ุขู ุงูฺฏู ุงุณุช.
    """
    if pattern_keys is None:
        pattern_keys = list(PATTERNS.keys())

    results = {}
    for key in pattern_keys:
        results[key] = extract_pattern(text, key)
    return results


def remove_repeated_chars(text: str, threshold: int = 3) -> str:
    """
    ุญุฐู ุง ฺฉุงูุด ุชฺฉุฑุงุฑ ุจุด ุงุฒ ุญุฏ ฺฉุงุฑุงฺฉุชุฑูุง (ูุซูุงู "ุนุงุงุงุงุงู" -> "ุนุงุงู").
    threshold ูุดุฎุต ูโฺฉูุฏ ฺูุฏ ุชฺฉุฑุงุฑ ูุฌุงุฒ ุจุงุดุฏ.

    Args:
        text (str): ูุชู ูุฑูุฏ
        threshold (int): ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ูุฌุงุฒ ุชฺฉุฑุงุฑ ูุชูุงู ฺฉุงุฑุงฺฉุชุฑ

    Returns:
        str: ูุชู ุงุตูุงุญโุดุฏู
    """
    pattern = rf"(.)\1{{{threshold},}}"

    def replacer(match):
        char = match.group(1)
        return char * threshold

    return re.sub(pattern, replacer, text)


def cleanup_text_for_compare(text: str) -> str:
    """
    ุญุฐู ุนูุงุฆู ูฺฏุงุฑุด ู ูุงุตููโูุง ุงุถุงู ุจุฑุง ููุงุณู ุฑุงุญุชโุชุฑ ูุชู.
    ุฏุฑ ุณูุฌุด ุดุจุงูุช ุฌููุงุช ุง ุจุฑุฑุณ ุชฺฉุฑุงุฑ ุจูุฏู ูุชู ฺฉุงุฑุจุฑุฏ ุฏุงุฑุฏ.

    Args:
        text (str): ูุชู ูุฑูุฏ

    Returns:
        str: ูุชู ุณุงุฏูโุณุงุฒโุดุฏู ุจุฑุง ููุงุณู
    """
    text = re.sub(r"[^\w\s\u0600-\u06FF\d]+", " ", text)
    text = re.sub(r"\s+", " ", text)
    return text.strip()


if __name__ == "__main__":
    sample_text = (
        "ุณูุงู! ุขุฏุฑุณ ุงูู ูู example@test.com ูุณุช. "
        "ุงูุฑูุฒ ฑดฐฑ/ฐต/ฑฒ ู 2021-12-31 ูุณุช ู ุณุงุนุช ฑฒ:ณฐ ุจ.ุธ ุงุณุช. "
        "ุดูุงุฑู ุชูุงุณ ูู +989123456789 ู ูุจูุบ ฒตฐ,ฐฐฐ ุชููุงู ูพุฑุฏุงุฎุช ุดุฏ. "
        "ฺฉุฏ ูู ูู 0043529517 ู ฺฉุฏ ูพุณุช 1234567890 ูโุจุงุดุฏ. "
        "ุขุฏุฑุณ IP ูู 192.168.1.1 ู IPv6 ูู 2001:0db8:85a3:0000:0000:8a2e:0370:7334 ุงุณุช. "
        "ูุดุชฺฏโูุง ูุงููุฏ #ุณูุงู ู ููุดูโูุง ูุงููุฏ @ฺฉุงุฑุจุฑ ุฏุฑ ูุชู ูุฌูุฏ ุฏุงุฑูุฏ. "
        "ุงููุฌโูุง ูุงููุฏ ๐ ู ๐ ูุฒ ุธุงูุฑ ูโุดููุฏ. "
        "ุนุฏุฏูุง ูุงููุฏ 1234.56 ู ฑฒณด ูุฒ ุจุงุฏ ุชุดุฎุต ุฏุงุฏู ุดููุฏ. "
        "ุชฺฏ HTML: <div class='sample'>ูุชู</div> ู ุดูุงุฑู ฺฉุงุฑุช 4111-1111-1111-1111 ูุฒ ูุฌูุฏ ุฏุงุฑูุฏ."
    )

    # ุชุณุช ุงุณุชุฎุฑุงุฌ ฺฉ ุงูฺฏู
    print("==== Test extract_pattern (EMAIL) ====")
    email_matches = extract_pattern(sample_text, "EMAIL")
    print("ุงููโูุง:", email_matches)

    # ุชุณุช ุงุณุชุฎุฑุงุฌ ููู ุงูฺฏููุง
    print("\n==== Test extract_all_patterns ====")
    all_results = extract_all_patterns(sample_text)
    for key, matches in all_results.items():
        print(f"{key}: {matches}")

    # ุชุณุช ุญุฐู ฺฉุงุฑุงฺฉุชุฑูุง ุชฺฉุฑุงุฑ
    repeated_text = "ุนุงุงุงุงุงู"
    print("\n==== Test remove_repeated_chars ====")
    print("ูุจู:", repeated_text, "\nุจุนุฏ:", remove_repeated_chars(repeated_text, threshold=2))

    # ุชุณุช cleanup_text_for_compare
    compare_text = "ุงู ฺฉ ูุชู!! ุขุฒูุงุด,,, ุจุฑุง ููุงุณู ุงุณุช."
    print("\n==== Test cleanup_text_for_compare ====")
    print("ูุจู:", compare_text, "\nุจุนุฏ:", cleanup_text_for_compare(compare_text))
