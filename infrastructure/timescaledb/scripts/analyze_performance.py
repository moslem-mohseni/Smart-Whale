import asyncio
import logging
from infrastructure.timescaledb.monitoring.metrics_collector import MetricsCollector
from infrastructure.timescaledb.monitoring.slow_query_analyzer import SlowQueryAnalyzer
from infrastructure.timescaledb.monitoring.health_check import HealthCheck
from infrastructure.timescaledb.storage.timescaledb_storage import TimescaleDBStorage
from infrastructure.timescaledb.config.connection_pool import ConnectionPool
from infrastructure.timescaledb.config.settings import TimescaleDBConfig

logger = logging.getLogger(__name__)


async def analyze_performance():
    """
    Ø§Ø¬Ø±Ø§ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
    """
    logger.info("ğŸ“Š Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡...")

    # Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø§Ú˜ÙˆÙ„ TimescaleDB
    config = TimescaleDBConfig()
    connection_pool = ConnectionPool(config)
    await connection_pool.initialize()

    storage = TimescaleDBStorage(connection_pool)
    metrics_collector = MetricsCollector(storage)
    slow_query_analyzer = SlowQueryAnalyzer(storage)
    health_check = HealthCheck(storage)

    try:
        # Ø¯Ø±ÛŒØ§ÙØª Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
        db_metrics = await metrics_collector.get_database_metrics()
        logger.info(f"ğŸ“Š Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: {db_metrics}")

        # Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ø¯ØªØ±ÛŒÙ† Ú©ÙˆØ¦Ø±ÛŒâ€ŒÙ‡Ø§
        slow_queries = await slow_query_analyzer.get_slow_queries()
        logger.info(f"ğŸ¢ Ú©Ù†Ø¯ØªØ±ÛŒÙ† Ú©ÙˆØ¦Ø±ÛŒâ€ŒÙ‡Ø§: {slow_queries}")

        # Ø¨Ø±Ø±Ø³ÛŒ Ù…ØµØ±Ù Ù…Ù†Ø§Ø¨Ø¹ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
        resource_usage = await health_check.get_resource_usage()
        logger.info(f"ğŸ“‰ Ù…ØµØ±Ù Ù…Ù†Ø§Ø¨Ø¹ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: {resource_usage}")

        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø­Ø±Ø§Ù†ÛŒ
        critical_issues = await health_check.check_critical_issues()
        logger.info(f"ğŸš¨ Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø­Ø±Ø§Ù†ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: {critical_issues}")

        logger.info("âœ… ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯.")
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: {e}")

    await connection_pool.close()

# Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
if __name__ == "__main__":
    asyncio.run(analyze_performance())
